<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Tablero de control del propietario</title>
		<link rel="stylesheet" href="../app.css" />
		<link rel="stylesheet" href="tablero.css" />
		<script src="../vistaWeb.js"></script>
		<script src="../sse.js"></script>
	</head>
	<body>
		<script src="../utilesVista.js"></script>

		<div class="container" style="display: none">
			<div class="header">
				<h1>Tablero de control del propietario</h1>
				<button class="btn-salir" onclick="logout()">Salir</button>
			</div>

			<div class="resumen-section">
				<h2>Resumen del propietario</h2>
				<div class="resumen-cards">
					<div class="resumen-card">
						<h6 class="resumen-card-label">NOMBRE COMPLETO</h6>
						<h4><label id="nombreCompleto"> </label></h4>
					</div>
					<div class="resumen-card">
						<h6 class="resumen-card-label">ESTADO</h6>
						<h4><label id="estadoPropietario"> </label></h4>
					</div>
					<div class="resumen-card">
						<h6 class="resumen-card-label">SALDO ACTUAL</h6>
						<h4>
							<label class="resumen-card-value" id="saldoActual"> </label>
						</h4>
					</div>
				</div>
			</div>

			<!-- Bonificaciones y Vehículos -->
			<div class="two-columns">
				<div class="section-card">
					<h3>Bonificaciones asignadas</h3>
					<div id="listaBonificaciones">
						<div class="sin-datos">No hay bonificaciones asignadas</div>
					</div>
				</div>

				<div class="section-card">
					<h3>Vehículos registrados</h3>
					<div id="listaVehiculos">
						<div class="sin-datos">No hay vehículos registrados</div>
					</div>
				</div>
			</div>

			<!-- Tránsitos realizados -->
			<div class="section-card" style="margin-bottom: 30px">
				<h3>Tránsitos realizados</h3>
				<div id="listaTransitos">
					<div class="sin-datos">No hay tránsitos realizados</div>
				</div>
			</div>

			<!-- Notificaciones del sistema -->
			<div class="notificaciones-section">
				<div class="notificaciones-header">
					<h3>Notificaciones del sistema</h3>
					<button
						class="btn-borrar"
						type="button"
						onclick="borrarNotificaciones(event)"
					>
						Borrar notificaciones
					</button>
				</div>
				<div id="listaNotificaciones">
					<div class="sin-datos">No hay notificaciones para borrar</div>
				</div>
			</div>
		</div>

		<script src="../vistaWeb.js"></script>
		<script src="../utilesVista.js"></script>
		<script>
			urlIniciarVista = '/propietario/vistaConectada';
			// El endpoint en el controlador es /propietario/vistaCerrada (metodo salir()), usar esa ruta para cerrar la vista
			urlCierreVista = '/propietario/vistaCerrada';
			urlRegistroSSE = '/propietario/registrarSSE';

			const spnNombreCompleto = document.getElementById('nombreCompleto');
			const spnEstadoPropietario = document.getElementById('estadoPropietario');
			const spnSaldoActual = document.getElementById('saldoActual');
			const listaBonificaciones = document.getElementById(
				'listaBonificaciones'
			);
			const listaVehiculos = document.getElementById('listaVehiculos');
			const listaTransitos = document.getElementById('listaTransitos');
			const listaNotificaciones = document.getElementById(
				'listaNotificaciones'
			);

			function cargarContenido(pagina) {
				document.getElementById('contenidoFrame').src = pagina;
			}

			function mostrar_tableroData(data) {
				spnNombreCompleto.innerHTML = data.nombreCompleto.toUpperCase();
				spnEstadoPropietario.innerHTML = data.estado.toUpperCase();
				spnSaldoActual.innerHTML = data.saldoActual;

				// Mostrar todas las listas como tablas HTML
				if (data.bonificaciones && data.bonificaciones.length > 0) {
					mostrar_bonificacionesAsignadas(data.bonificaciones);
				} else {
					listaBonificaciones.innerHTML =
						'<div class="sin-datos">No hay bonificaciones asignadas</div>';
				}

				if (data.vehiculos && data.vehiculos.length > 0) {
					listaVehiculos.innerHTML = crearTablaDesdeJson(data.vehiculos);
				} else {
					listaVehiculos.innerHTML =
						'<div class="sin-datos">No hay vehículos registrados</div>';
				}

				if (data.transitos && data.transitos.length > 0) {
					listaTransitos.innerHTML = crearTablaDesdeJson(data.transitos);
				} else {
					listaTransitos.innerHTML =
						'<div class="sin-datos">No hay tránsitos realizados</div>';
				}

				if (data.notificaciones && data.notificaciones.length > 0) {
					listaNotificaciones.innerHTML = crearTablaDesdeJson(
						data.notificaciones
					);
				} else {
					listaNotificaciones.innerHTML =
						'<div class="sin-datos">No hay notificaciones para borrar</div>';
				}
			}

			function logout() {
				// Primero avisar al controlador de la vista para quitar observadores
				fetch('/propietario/vistaCerrada', {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: '',
				}).catch(() => {});

				submit('/auth/logout');
			}

			// Esta función es llamada desde vistaWeb.js después de que finaliza el primer submit
			function primerSubmitFinalizado() {
				// Si llegamos acá, la inicialización de la vista (urlIniciarVista) fue exitosa
				const cont = document.querySelector('.container');
				if (cont) cont.style.display = 'block';
			}

			function mostrar_bonificacionesAsignadas(bonificaciones) {
				// Renderiza una tabla con bonificación, puesto y fecha (igual que en admin/bonificaciones.html)
				const cont = document.getElementById('listaBonificaciones');
				cont.innerHTML = '';
				const table = document.createElement('table');
				const thead = document.createElement('thead');
				thead.innerHTML = `
					<tr>
						<th>Bonificación</th>
						<th>Puesto</th>
						<th>Fecha asignación</th>
					</tr>
				`;
				table.appendChild(thead);
				const tbody = document.createElement('tbody');
				if (bonificaciones && bonificaciones.length > 0) {
					bonificaciones.forEach((b) => {
						const tr = document.createElement('tr');
						const fecha = b.fechaAsignada
							? new Date(b.fechaAsignada).toLocaleDateString()
							: '';
						tr.innerHTML = `
							<td>${b.nombreBonificacion || ''}</td>
							<td>${b.nombrePuesto || ''}</td>
							<td>${fecha}</td>
						`;
						tbody.appendChild(tr);
					});
				} else {
					const tr = document.createElement('tr');
					tr.innerHTML = '<td colspan="3">Sin bonificaciones asignadas</td>';
					tbody.appendChild(tr);
				}
				table.appendChild(tbody);
				cont.appendChild(table);
			}

			function procesarErrorSubmit(status, text) {
				if (status == 400) {
					window.location.href = '/login/propietario.html';
				}
			}

			function borrarNotificaciones(event) {
				event.preventDefault();
				submit('/propietario/borrar-notificaciones');
			}

			async function mostrar_mensaje(mensaje) {
				await mostrarMensaje(mensaje);
			}

			async function excepcionDeAplicacion(mensaje) {
				await mostrarMensaje(mensaje);
			}

			function mostrar_paginaLogin(url) {
				window.location.href = url;
			}
		</script>
	</body>
</html>
