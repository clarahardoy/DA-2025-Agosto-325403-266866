<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Administrador - Principal</title>
		<link rel="stylesheet" href="/app.css" />
		<script src="/utilesVista.js"></script>
		<script src="/vistaWeb.js"></script>
		<script src="/sse.js"></script>

	</head>
	<body>
		<div class="sidebar">
			<label id="nombreCompleto"> </label>
			<button onclick="cargarContenido('transito.html')">
				Emular Transito
			</button>
			<button onclick="cargarContenido('bonificaciones.html')">
				Asignar Bonificaciones
			</button>
			<button onclick="cargarContenido('estado.html')">
				Cambiar Estado de Propietario
			</button>
			<button onclick="logout()">Salir</button>
		</div>
		<div class="content">
			<iframe
				id="contenidoFrame"
				src="transito.html"
				frameborder="0"
				style="width: 100%; height: 80vh"
			></iframe>
		</div>
		<script>
			urlIniciarVista = '/menu/vistaConectada';
			urlCierreVista = '/auth/logout';
		    urlRegistroSSE = "/menu/registrarSSE";


			const spnNombreCompleto = document.getElementById('nombreCompleto');

			function cargarContenido(pagina) {
				document.getElementById('contenidoFrame').src = pagina;
			}
			function mostrar_nombreCompleto(nombreCompleto) {
				spnNombreCompleto.innerHTML =
					'Administrador: ' + nombreCompleto.toUpperCase();
			}

			function mostrar_paginaLogin(url) {
				window.location.href = url;
			}
			
			function mostrar_logout(pagina) {
				window.location.href = '/login/administrador.html';
			}

			function logout() {
				submit(urlCierreVista);
			}
		function procesarErrorSubmit(status, text) {
				if (status == 400) {
					//El usuario no ha iniciado sesion
					mostrar_paginaLogin( '/login/administrador.html');
				}
		}

		        //Cuando llega un mensaje SSE lo delego al iFrame actual como una respuesta del controlador
        function procesarMensajeSSE(mensaje) {
  
            var iframe = document.getElementById('contenidoFrame');
            var iframeWindow = iframe.contentWindow;
            iframeWindow.procesarResultadosSubmit(mensaje); //asumo que el iFrame tiene vistaWeb.js incluida
        }
        
        //Se ejecuta cuando se cierra la conexion desde el servidor
        //Si no se define esta funcion, por defecto se "borra" la pagina 
        function conexionSSECerrada(event){
              cerrar();
        }
        async function cerrar(){
            let respuesta = await mostrarConfirmacion("Se ha cerrado la aplicacion en esta ventana", "Intentar volver a abrirla", "Cerrar");
            if (respuesta) {
                // Intentar volver a abrirla -> redirigir al login para que vuelva a entrar
                mostrar_logout('login-admin');
            } else {
                // Cerrar -> borrar la p√°gina
                document.body.innerHTML = '';
            }
        }

		</script>
	</body>
</html>
